name: Security Audit

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6AM UTC
  push:
    branches: [main, develop]
    paths:
      - 'pyproject.toml'
      - 'requirements*.txt'
      - 'gestvenv/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] pip-audit
        pip install -e . || pip install .

    # Primary vulnerability scanner (free, no API key required)
    - name: Run pip-audit (dependency vulnerabilities)
      id: pip-audit
      continue-on-error: true
      run: |
        echo "## Dependency Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
        pip-audit --format=markdown >> $GITHUB_STEP_SUMMARY 2>&1 || true
        pip-audit --format=json --output=pip-audit-report.json || true

    # Static code analysis for security issues
    - name: Run bandit (code security analysis)
      id: bandit
      continue-on-error: true
      run: |
        echo "## Code Security Analysis" >> $GITHUB_STEP_SUMMARY
        bandit -r gestvenv/ -f txt >> $GITHUB_STEP_SUMMARY 2>&1 || true
        bandit -r gestvenv/ -f json -o bandit-report.json || true

    # Summary report
    - name: Generate security summary
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.pip-audit.outcome }}" == "success" ]; then
          echo "| pip-audit | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| pip-audit | :warning: Issues found |" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ steps.bandit.outcome }}" == "success" ]; then
          echo "| bandit | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| bandit | :warning: Issues found |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          pip-audit-report.json
          bandit-report.json
        retention-days: 30

    # Check for critical vulnerabilities
    - name: Check for critical vulnerabilities
      run: |
        # Check pip-audit for vulnerabilities
        # pip-audit JSON format: list of {name, version, vulns: [...]}
        if [ -f pip-audit-report.json ] && [ -s pip-audit-report.json ]; then
          VULN_COUNT=$(python -c "
import json, sys
try:
    with open('pip-audit-report.json') as f:
        data = json.load(f)
    # Count packages with vulnerabilities
    if isinstance(data, list):
        count = sum(1 for pkg in data if pkg.get('vulns'))
    else:
        count = len(data.get('dependencies', []))
    print(count)
except:
    print(0)
" 2>/dev/null || echo "0")
          if [ "$VULN_COUNT" != "0" ] && [ "$VULN_COUNT" != "" ]; then
            echo "::warning::Found $VULN_COUNT packages with vulnerabilities"
          fi
        fi

        # Check bandit for high severity issues (excluding nosec comments)
        if [ -f bandit-report.json ] && [ -s bandit-report.json ]; then
          HIGH_COUNT=$(python -c "
import json
try:
    with open('bandit-report.json') as f:
        data = json.load(f)
    results = data.get('results', [])
    high_issues = [r for r in results if r.get('issue_severity') == 'HIGH']
    print(len(high_issues))
except:
    print(0)
" 2>/dev/null || echo "0")
          if [ "$HIGH_COUNT" != "0" ] && [ "$HIGH_COUNT" != "" ]; then
            echo "::warning::Found $HIGH_COUNT high severity code issues"
          fi
        fi
